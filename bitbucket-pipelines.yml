image: docker/compose:1.29.2

pipelines:
  default:
    - step:
        script:
          - printenv | grep PLUGIN_ >> .env
          - docker-compose up -d --build
          - docker-compose run --rm plugin clone ${PLUGIN_REPOSITORY} temp
          - docker-compose run --rm cli sh -c "/scripts/wait-for-it.sh db:3306"
          - docker-compose run --rm cli sh -c "mkdir -p ./wp-content/plugins/${PLUGIN_NAME}"
          - docker-compose run --rm cli sh -c "cp -R /plugin/temp/* ./wp-content/plugins/${PLUGIN_NAME}"
          - docker-compose run --rm cli sh -c "/scripts/wordpress.sh"
          - docker-compose run --rm cli [ -f ./wp-content/plugins/${PLUGIN_NAME}/tests/e2e/cli/cli.sh ] && sh ./wp-content/plugins/${PLUGIN_NAME}/tests/e2e/cli/cli.sh
          - echo "Tests for PB checkout run here"
          - docker-compose run e2e --record --key $PLUGIN_CYPRESS_KEY
          - echo "Switching to USM"
          - docker-compose run --rm cli sh ./wp-content/plugins/${PLUGIN_NAME}/tests/e2e/cli/checkout_template.sh new_universal_shipping
          - echo "Tests for PB USM run here"
        services:
          - docker
        caches:
          - docker